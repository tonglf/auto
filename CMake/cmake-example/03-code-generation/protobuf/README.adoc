# Protobuf Code Generation

## Introduction

This example shows how to generate source files using [protobuf](https://github.com/google/protobuf). Protocol Buffers is a data serialization format from Google. A user provides a `.proto` file with a description of the data. Then using the protobuf compiler, the proto file can be translated into source code in a number of languages including C++.

The files in this tutorial are below:

```bash
$ tree
.
├── AddressBook.proto
├── CMakeLists.txt
├── main.cpp
```

- AddressBook.proto - proto file from main protocol buffer [example](https://developers.google.com/protocol-buffers/docs/cpptutorial)
- CMakeLists.txt - Contains the CMake commands you wish to run
- main.cpp- The source file from the protobuf example.

## Requirements

This example requires the protocol buffers binary and libraries to be installed.

This can be installed on Ubuntu using

```bash
sudo apt-get install protobuf-compiler libprotobuf-dev
```

## Concepts

### Exported Variables

The variables exported by the CMake protobuf package and used in this example include:

- `PROTOBUF_FOUND` - If Protocol Buffers is installed
- `PROTOBUF_INCLUDE_DIRS` - The protobuf header files
- `PROTOBUF_LIBRARIES` - The protobuf library

More variables are defined and can be found by examining the documentation at the top of your `FindProtobuf.cmake` file.

### Generating Source

The protobuf CMake package includes a number of helper functions to make the code generation easier. In this example we are generating C++ source and use the following code:

```
PROTOBUF_GENERATE_CPP(PROTO_SRCS PROTO_HDRS AddressBook.proto)
```

The arguments are:

- PROTO_SRCS - Name of the variable that will store the .pb.cc files.
- PROTO_HDRS- Name of the variable that will store the .pb.h files.
- AddressBook.proto - The .proto file to generate code from.

### Generated Files

After the `PROTOBUF_GENERATE_CPP` function is called, you will have the above mentioned variables available. These will be marked as the output to a custom command which calls the protobuf compiler binary to generate them.

To then have the files generated you should add them to a library or executable. For example:

```cmake
add_executable(protobuf_example
    main.cpp
    ${PROTO_SRCS}
    ${PROTO_HDRS})
```

This will cause the protobuf compiler to be called when you call `make` on that executables target.

When changes are made to the .proto file, the associated source files will be autogenerated again. However, if no changes are made to the .proto file and you re-run make, then nothing will be done.

## Building the Example

```bash
$ mkdir build

$ cd build/

$ cmake ..

$ ls
CMakeCache.txt  CMakeFiles  cmake_install.cmake  Makefile

$ make VERBOSE=1

$ ls
AddressBook.pb.cc  CMakeCache.txt  cmake_install.cmake  protobuf_example
AddressBook.pb.h   CMakeFiles      Makefile

$ ./protobuf_example test.db
test.db: File not found.  Creating a new file.
Enter person ID number: 11
Enter name: John Doe
Enter email address (blank for none): wolly@sheep.ie
Enter a phone number (or leave blank to finish):

$ ls
AddressBook.pb.cc  CMakeCache.txt  cmake_install.cmake  protobuf_example
AddressBook.pb.h   CMakeFiles      Makefile             test.db
```